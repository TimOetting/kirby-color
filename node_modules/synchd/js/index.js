"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require("babel-runtime/core-js/promise");

var _promise2 = _interopRequireDefault(_promise);

var _weakMap = require("babel-runtime/core-js/weak-map");

var _weakMap2 = _interopRequireDefault(_weakMap);

exports.synchd = synchd;
exports.synchdFn = synchdFn;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var queues = new _weakMap2.default();

function noop() {}

function rethrow(e) {
  throw e;
}

function synchd(scopeKey, fn) {
  var waitOn = queues.get(scopeKey) || _promise2.default.resolve();
  var p = waitOn.then(fn);

  // The Promise stored in the WeakMap shouldn't contain a value.
  queues.set(scopeKey, p.then(noop, noop));

  // An error handler was added above which would prevent the runtime from
  // possibly detecting an uncaught rejection, so we set up a re-throwing
  // error handler which it's up to the caller to attach an error handler to
  // or not.
  return p.catch(rethrow);
}

function synchdFn(scopeKey, fn) {
  return function () {
    var _this = this,
        _arguments = arguments;

    return synchd(scopeKey, function () {
      return fn.apply(_this, _arguments);
    });
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJzeW5jaGQiLCJzeW5jaGRGbiIsInF1ZXVlcyIsIm5vb3AiLCJyZXRocm93IiwiZSIsInNjb3BlS2V5IiwiZm4iLCJ3YWl0T24iLCJnZXQiLCJyZXNvbHZlIiwicCIsInRoZW4iLCJzZXQiLCJjYXRjaCIsImFwcGx5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztRQVVnQkEsTSxHQUFBQSxNO1FBY0FDLFEsR0FBQUEsUTs7OztBQXRCaEIsSUFBTUMsU0FBdUMsdUJBQTdDOztBQUVBLFNBQVNDLElBQVQsR0FBZ0IsQ0FBRTs7QUFFbEIsU0FBU0MsT0FBVCxDQUFpQkMsQ0FBakIsRUFBb0I7QUFDbEIsUUFBTUEsQ0FBTjtBQUNEOztBQUVNLFNBQVNMLE1BQVQsQ0FBbUJNLFFBQW5CLEVBQXFDQyxFQUFyQyxFQUF1RTtBQUM1RSxNQUFNQyxTQUFTTixPQUFPTyxHQUFQLENBQVdILFFBQVgsS0FBd0Isa0JBQVFJLE9BQVIsRUFBdkM7QUFDQSxNQUFNQyxJQUFJSCxPQUFPSSxJQUFQLENBQVlMLEVBQVosQ0FBVjs7QUFFQTtBQUNBTCxTQUFPVyxHQUFQLENBQVdQLFFBQVgsRUFBcUJLLEVBQUVDLElBQUYsQ0FBT1QsSUFBUCxFQUFhQSxJQUFiLENBQXJCOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBT1EsRUFBRUcsS0FBRixDQUFRVixPQUFSLENBQVA7QUFDRDs7QUFFTSxTQUFTSCxRQUFULENBQXVESyxRQUF2RCxFQUF5RUMsRUFBekUsRUFBbUY7QUFDeEYsU0FBUSxZQUFXO0FBQUE7QUFBQTs7QUFDakIsV0FBT1AsT0FBT00sUUFBUCxFQUFpQixZQUFNO0FBQzVCLGFBQU9DLEdBQUdRLEtBQUgsbUJBQVA7QUFDRCxLQUZNLENBQVA7QUFHRCxHQUpEO0FBS0QiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5jb25zdCBxdWV1ZXM6IFdlYWtNYXA8T2JqZWN0LFByb21pc2U8YW55Pj4gPSBuZXcgV2Vha01hcCgpO1xuXG5mdW5jdGlvbiBub29wKCkge31cblxuZnVuY3Rpb24gcmV0aHJvdyhlKSB7XG4gIHRocm93IGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzeW5jaGQ8Uj4oc2NvcGVLZXk6IE9iamVjdCwgZm46ICgpID0+IFByb21pc2U8Uj4pOiBQcm9taXNlPFI+IHtcbiAgY29uc3Qgd2FpdE9uID0gcXVldWVzLmdldChzY29wZUtleSkgfHwgUHJvbWlzZS5yZXNvbHZlKCk7XG4gIGNvbnN0IHAgPSB3YWl0T24udGhlbihmbik7XG5cbiAgLy8gVGhlIFByb21pc2Ugc3RvcmVkIGluIHRoZSBXZWFrTWFwIHNob3VsZG4ndCBjb250YWluIGEgdmFsdWUuXG4gIHF1ZXVlcy5zZXQoc2NvcGVLZXksIHAudGhlbihub29wLCBub29wKSk7XG5cbiAgLy8gQW4gZXJyb3IgaGFuZGxlciB3YXMgYWRkZWQgYWJvdmUgd2hpY2ggd291bGQgcHJldmVudCB0aGUgcnVudGltZSBmcm9tXG4gIC8vIHBvc3NpYmx5IGRldGVjdGluZyBhbiB1bmNhdWdodCByZWplY3Rpb24sIHNvIHdlIHNldCB1cCBhIHJlLXRocm93aW5nXG4gIC8vIGVycm9yIGhhbmRsZXIgd2hpY2ggaXQncyB1cCB0byB0aGUgY2FsbGVyIHRvIGF0dGFjaCBhbiBlcnJvciBoYW5kbGVyIHRvXG4gIC8vIG9yIG5vdC5cbiAgcmV0dXJuIHAuY2F0Y2gocmV0aHJvdyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzeW5jaGRGbjxGOiAoLi4uYXJnczogYW55W10pID0+IFByb21pc2U8YW55Pj4oc2NvcGVLZXk6IE9iamVjdCwgZm46IEYpOiBGIHtcbiAgcmV0dXJuIChmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gc3luY2hkKHNjb3BlS2V5LCAoKSA9PiB7XG4gICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9KTtcbiAgfTogYW55KTtcbn1cbiJdfQ==